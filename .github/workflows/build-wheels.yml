name: Build Wheels

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build_wheels:
    name: Build wheels
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Build regular wheels
      uses: pypa/cibuildwheel@v2.16.2
      env:
        CIBW_BUILD: cp310-* cp311-* cp312-* cp313-* cp314-*
        CIBW_SKIP: "*-musllinux_* *-win32"
        CIBW_MANYLINUX_X86_64_IMAGE: manylinux2014
        # Fix CentOS mirrors and install zstd (optional)
        CIBW_BEFORE_ALL_LINUX: >
          sed -i 's|mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/CentOS-* 2>/dev/null || true &&
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-* 2>/dev/null || true &&
          (yum install -y libzstd-devel || echo "zstd not available, building without compression")
        CIBW_BEFORE_BUILD: pip install setuptools wheel
        CIBW_TEST_REQUIRES: pytest
        CIBW_TEST_COMMAND: "pytest {project}/tests/unit"

    - name: Build PyPy wheels
      uses: pypa/cibuildwheel@v2.16.2
      env:
        CIBW_BUILD: pp310-* pp311-*
        CIBW_SKIP: "*-musllinux_* *-win32"
        CIBW_MANYLINUX_X86_64_IMAGE: manylinux2014
        CIBW_BEFORE_ALL_LINUX: >
          sed -i 's|mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/CentOS-* 2>/dev/null || true &&
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-* 2>/dev/null || true &&
          (yum install -y libzstd-devel || echo "zstd not available, building without compression")
        CIBW_BEFORE_BUILD: pip install setuptools wheel
        CIBW_TEST_REQUIRES: pytest
        CIBW_TEST_COMMAND: "pytest {project}/tests/unit"

    - uses: actions/upload-artifact@v4
      with:
        name: wheels
        path: ./wheelhouse/*.whl

  build_freethreading_wheels:
    name: Build free-threading wheels
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13t", "3.14t"]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        allow-prereleases: true

    - name: Set PYTHON_GIL=0
      run: |
        echo "PYTHON_GIL=0" >> "$GITHUB_ENV"

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip build wheel setuptools

    - name: Verify free-threading is enabled
      run: |
        python --version --version
        python -c "import sys; print('sys._is_gil_enabled:', sys._is_gil_enabled())"
        python -c "import sysconfig; print('Py_GIL_DISABLED:', sysconfig.get_config_var('Py_GIL_DISABLED'))"

    - name: Install auditwheel
      run: |
        python -m pip install auditwheel

    - name: Build wheel
      run: |
        python -m build --wheel
      env:
        CC: gcc

    - name: Repair wheel to manylinux
      run: |
        auditwheel repair dist/*.whl -w dist/
        rm dist/*-linux_x86_64.whl  # Remove non-manylinux wheel

    - name: Install and test wheel
      run: |
        pip install dist/*.whl
        pip install pytest
        PYTHON_GIL=0 pytest tests/unit tests/integration -v

    - uses: actions/upload-artifact@v4
      with:
        name: freethreading-wheels-${{ matrix.python-version }}
        path: dist/*.whl
